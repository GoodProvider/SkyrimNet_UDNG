{# Core state detection - sets variables used by other templates #}
{% set actor_name = decnpc(actorUUID).name %}
{% set actor_gender = lower(decnpc(actorUUID).sex) %}
{% set bound_armor = has_spell(actorUUID, "REQ_Conjuration3_Bound_Armor") %}

{# Arousal levels from faction rank #}
{% set arousal_level = get_faction_rank(actorUUID, "sla_Arousal") %}
{% if arousal_level < 35 %}
  {% set arousal_state = "not_aroused" %}
{% else if arousal_level < 75 %}
  {% set arousal_state = "moderately_aroused" %}
{% else %}
  {% set arousal_state = "highly_aroused" %}
{% endif %}

{# Nudity detection #}
{% if worn_has_keyword(actorUUID, "Eroticarmor") or worn_has_keyword(actorUUID, "sla_armorspendex") or worn_has_keyword(actorUUID, "sla_armorhalfnakedbikini") or worn_has_keyword(actorUUID, "sla_armorhalfnaked") %}
  {% set clothing_state = "minimal" %}
{% else if worn_has_keyword(actorUUID, "ArmorCuirass") or worn_has_keyword(actorUUID, "ClothingBody") or bound_armor %}
  {% set clothing_state = "clothed" %}
{% else %}
  {% set clothing_state = "nude" %}
{% endif %}

{# Vibration capabilities and status #}
{% set has_vibrators = (worn_has_keyword(actorUUID, "zad_DeviousPlugVaginal") or worn_has_keyword(actorUUID, "zad_DeviousPlugAnal") or worn_has_keyword(actorUUID, "zad_DeviousPiercingsNipple") or worn_has_keyword(actorUUID, "zad_DeviousPiercingsVaginal")) %}
{% set vibrators_active = is_in_faction(actorUUID, "zadVibratorFaction") %}

{# Render mode flags #}
{% set show_internal = (render_mode == "full" or render_mode == "thoughts" or render_mode == "thought" or render_mode == "transform" or render_mode == "book") %}
{% set show_external_only = (render_mode == "dialogue_target") %}